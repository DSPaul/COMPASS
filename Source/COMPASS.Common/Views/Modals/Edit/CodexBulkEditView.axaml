<UserControl xmlns="https://github.com/avaloniaui"
             xmlns:x="http://schemas.microsoft.com/winfx/2006/xaml"
             xmlns:d="http://schemas.microsoft.com/expression/blend/2008"
             xmlns:mc="http://schemas.openxmlformats.org/markup-compatibility/2006"
             xmlns:vm="using:COMPASS.Common.ViewModels.Modals.Edit"
             xmlns:controls="using:COMPASS.Common.Controls"
             xmlns:converters="using:COMPASS.Common.Converters"
             xmlns:dataTemplates="using:COMPASS.Common.DataTemplates"
             xmlns:model="using:COMPASS.Common.Models"
             xmlns:hierarchy="using:COMPASS.Common.Models.Hierarchy"
             xmlns:materialIcons="using:Material.Icons.Avalonia"
             mc:Ignorable="d" d:DesignWidth="1200" d:DesignHeight="500"
             x:Class="COMPASS.Common.Views.Modals.Edit.CodexBulkEditView"
             x:DataType="vm:CodexBulkEditViewModel">

    <Grid Name="MainGrid" Focusable="True" Margin="5,10"
          RowDefinitions="auto,auto,auto,auto,auto,auto,auto,*,auto"
          ColumnDefinitions="*,auto,auto,auto">

        <Grid.Styles>
            <Style Selector="TextBlock">
                <Setter Property="Margin" Value="3,0" />
                <Setter Property="VerticalAlignment" Value="Center" />
            </Style>
            <Style Selector="TextBox">
                <Setter Property="VerticalAlignment" Value="Center" />
                <Setter Property="VerticalContentAlignment" Value="Center" />
            </Style>
        </Grid.Styles>

        <TextBlock Text="Authors:" Margin="0,10" />
        <controls:MultiSelectAutoCompleteBox Grid.Row="1" Grid.Column="0" 
                                             ItemsSource="{Binding MVM.CollectionVM.FilterVM.AuthorList}"
                                             SelectedItems="{Binding Authors, Mode=TwoWay}"
                                             Watermark="Add author" CanCreate="True"/>

        <TextBlock Text="Publisher:" Grid.Row="2" Grid.Column="0" Margin="0,10" />
        <!-- TODO allow creating new elements, keep an eye on avalonia #18094 -->
        <ComboBox Grid.Row="3" Grid.Column="0"
                  HorizontalAlignment="Stretch"
                  BorderBrush="LightGray"
                  Background="{DynamicResource TextControlBackground}"
                  SelectedItem="{Binding Publisher}"
                  ItemsSource="{Binding PublisherOptions}" />

        <!-- Smaller properties -->
        <Grid Grid.Row="4" Grid.Column="0" Margin="0,10"
              ColumnDefinitions="*, *, 0.5*, *, 1.5*"
              RowDefinitions="Auto, Auto, Auto">

            <!-- Version -->
            <TextBlock Grid.Row="0" Grid.Column="0"
                       Text="Version:" />
            <TextBox Grid.Row="0" Grid.Column="1"
                     Text="{Binding Version, Mode=TwoWay}" Margin="5,0" />

            <!-- Hard Copy -->
            <TextBlock Grid.Row="1" Grid.Column="0" Margin="3,0"
                       Text="Hard Copy:" />
            <CheckBox Grid.Row="1" Grid.Column="1" Margin="3,0" IsThreeState="True"
                      IsChecked="{Binding PhysicallyOwned, Mode=TwoWay}" />

            <!-- Release Date -->
            <!-- TODO Add clear btn if not default  -->
            <TextBlock Grid.Row="0" Grid.Column="3"
                       Text="Release Date:" />
            <CalendarDatePicker Grid.Row="0" Grid.Column="4" Width="140"
                                SelectedDate="{Binding ReleaseDate}" />

            <!-- Rating -->
            <!-- TODO Add clear btn if not default  -->
            <TextBlock Grid.Row="1" Grid.Column="3"
                       Text="Rating:" />
            <controls:RatingControl Grid.Column="4" Grid.Row="1" Margin="5"
                                    Value="{Binding Rating, Mode=TwoWay}"
                                    CanClear="True"/>
        </Grid>

        <Grid Grid.Row="5" Grid.ColumnSpan="2" Grid.Column="0" 
              ColumnDefinitions="auto,*" 
              RowDefinitions="auto,auto">

            <Grid.DataTemplates>
                <DataTemplate DataType="{x:Type model:Tag}">
                        <Button Classes="BlankButton"
                                Command="{Binding $parent[ItemsControl].((vm:CodexBulkEditViewModel)DataContext).RemoveFromItemsControlCommand}"
                                CommandParameter="{Binding}" Cursor="Hand">
                            <Button.Styles>
                                <Style Selector="Border:pointerover > StackPanel">
                                    <Style Selector="^ > TextBlock">
                                        <Setter Property="TextDecorations" Value="Strikethrough" />
                                    </Style>
                                    <Style Selector="^ > materialIcons|MaterialIcon">
                                        <Setter Property="IsVisible" Value="True" />
                                    </Style>
                                </Style>
                            </Button.Styles>
                            <Button.Template>
                                <ControlTemplate>
                                    <Border CornerRadius="5" Margin="2,3"
                                            Background="{Binding BackgroundColor, Converter={x:Static converters:ColorConverters.ColorToBrush}}">
                                        <StackPanel Orientation="Horizontal" Margin="7,2">
                                            <TextBlock x:Name="DeletableTagTextBlock" Text="{Binding LongName}"
                                                       FontSize="14" Margin="2,0" />
                                            <materialIcons:MaterialIcon Kind="Trash" IsVisible="False" Width="14"
                                                                        Height="14" VerticalAlignment="Bottom" Margin="0,1" />
                                        </StackPanel>
                                    </Border>
                                </ControlTemplate>
                            </Button.Template>
                        </Button>
                    </DataTemplate>
            </Grid.DataTemplates>
            
            <TextBlock Text="Tags To Add:" />
            <!-- Todo use the same control as authors for this -->
            <Border Grid.Row="0" Grid.Column="1" BorderBrush="Gray" BorderThickness="2" CornerRadius="5" Padding="10,3"
                    Margin="5">
                <ItemsControl ItemsSource="{Binding TagsToAdd}" VerticalAlignment="Center" MinHeight="20">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </Border>


            <TextBlock Grid.Row="1" Grid.Column="0" Text="Tags To Remove:" />
            <Border Grid.Row="1" Grid.Column="1" BorderBrush="Gray" BorderThickness="2"
                    CornerRadius="5" Padding="10,3" Margin="5">
                <ItemsControl ItemsSource="{Binding TagsToRemove}" VerticalAlignment="Center" MinHeight="20">
                    <ItemsControl.ItemsPanel>
                        <ItemsPanelTemplate>
                            <WrapPanel Orientation="Horizontal" />
                        </ItemsPanelTemplate>
                    </ItemsControl.ItemsPanel>
                </ItemsControl>
            </Border>
        </Grid>

        <controls:ConfirmControls Grid.Row="8" Grid.ColumnSpan="2" Grid.Column="0"
                                  HorizontalAlignment="Right" />

        <Rectangle Grid.Column="2" Grid.Row="0" Grid.RowSpan="9" Fill="DarkGray" Width="3" Margin="10,0" />

        <TextBlock Grid.Column="3" Grid.Row="0" Text="Add/Remove Tags" TextAlignment="Center"
                   HorizontalAlignment="Stretch"
                   FontWeight="Bold" />

        <TreeView Grid.Row="1" Grid.Column="3" Grid.RowSpan="8"
                  MinWidth="200" MaxHeight="400"
                  BorderBrush="{x:Null}" Background="Transparent"
                  Classes="NoSelection"
                  ItemsSource="{Binding AllTagsAsTreeNodes}">
            <TreeView.ItemTemplate>
                <dataTemplates:TagTreeDataTemplateSelector>
                    <TreeDataTemplate x:Key="RegularTag" DataType="hierarchy:TagTreeNode"
                                      ItemsSource="{Binding Children}">
                        <Border CornerRadius="5" Margin="0, 3, 5, 0">
                            <Border.Background>
                                <SolidColorBrush Color="{Binding Item.BackgroundColor}" />
                            </Border.Background>
                            <StackPanel Orientation="Horizontal">
                                <controls:IconButton Theme="{StaticResource IconOnly}" 
                                                     Icon="AddCircleOutline"
                                                     Margin="5,0,0,0"
                                                     Command="{Binding $parent[TreeView].((vm:CodexBulkEditViewModel)DataContext).AddTagCommand}"
                                                     CommandParameter="{Binding Item}"/>
                                <controls:IconButton Theme="{StaticResource IconOnly}" 
                                                     Icon="MinusCircleOutline"
                                                     Margin="5,0,0,0"
                                                     Command="{Binding $parent[TreeView].((vm:CodexBulkEditViewModel)DataContext).RemoveTagCommand}"
                                                     CommandParameter="{Binding Item}"/>
                                <Rectangle Width="2" Fill="{StaticResource TextMutedColor}" Margin="5,1" />
                                <TextBlock Text="{Binding Item.Name}" Margin="5,2" />
                            </StackPanel>
                        </Border>
                    </TreeDataTemplate>
                    <TreeDataTemplate x:Key="GroupTag" DataType="hierarchy:TagTreeNode"
                                      ItemsSource="{Binding Children}">
                        <controls:Chip Theme="{StaticResource GroupChip}" Text="{Binding Item.Name}"
                                       HorizontalAlignment="Stretch" Margin="0,3,20,3"
                                       Background="{Binding Item.BackgroundColor, Converter={x:Static converters:ColorConverters.ColorToBrush}}" />
                    </TreeDataTemplate>
                </dataTemplates:TagTreeDataTemplateSelector>
            </TreeView.ItemTemplate>
            <TreeView.Styles>
                <Style Selector="TreeViewItem" x:DataType="model:IExpandable">
                    <Setter Property="IsExpanded" Value="{Binding Expanded}" />
                </Style>
            </TreeView.Styles>
        </TreeView>

    </Grid>
</UserControl>